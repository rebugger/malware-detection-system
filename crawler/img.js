var request = require("request");
var client = require('cheerio-httpcli');
var urlType = require('url');
var fs = require('fs')
var async = require('async')
var path = require('path')
var jsonPath = path.join(__dirname, '../log/img_src/found.txt');

// var logPath = require('../log/')

module.exports = function(list) {
    var cList = []; 
    cList = list.Ulist
    var cLength = list.Ulist.length

    
    async.eachLimit(cList, cLength, function(clist, next){
        WF_crawler(clist);
    })

    function WF_crawler(url) {
        client.fetch(url,function(err, $, res){
            var result = [];
            var img_result;
            if(err) throw err;
            else{
                $('img').each(function(idx, data){
                    var img_src = $(this).attr('src');

                    if(typeof(img_src) !== 'undefined' && img_src !== 'javascript:;' && img_src !== '#'){
                        var itUrl = img_src
                        // if(itUrl.indexOf('h',1)){
                        //     console.log('why?', itUrl)
                        // }
                        // var itUrl = urlType.resolve(url,href)
                        if(idx === 100){
                            return false;
                            console.log('img crawler 중지;')
                        }
                        if(idx === 1){
                            // console.log(idx === 1)
                            result.push(itUrl);
                        }
                        else{
                            if(result.indexOf(itUrl) > -1){
                            }
                            else{
                                result.push(itUrl)  
                            }
                            // console.log(result.length)
                        }
                    }
                })
                WF_IN_log_foundJson(result) //데이터 저장
            }
            console.log('img 끝')
        })
    }

    function WF_IN_log_foundJson(log){
        // obj.Flist.push(itUrl)
        // href_result = JSON.stringify(obj)
        fs.appendFileSync(jsonPath, log, 'utf8'),function(err){
            if(err) console.log('error  : ', err)
        }
        
    }


    function WF_pushReuslt(result){
        return totalUrl.push(result)
    }

    function WF_checkUrl(list) {
        return total = list.Ulist[list_count]
        list_count++
    }

}


// asynce.waterfall([
    //     function(callback){
    //         async.eachLimit(cList, cLength, function(clist, next){
    //             totalUrl = WF_crawler(clist);
    //         })
    //     }
    // ])

